name: CI

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    branches:
      - master

jobs:
  tests:
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.merged == false &&
      github.event.pull_request.state == 'open'
    steps:
      - uses: actions/checkout@v3

    #  - name: Setup Python
    #    uses: actions/setup-python@v4
    #    with:
    #      python-version: 3.8
    #  - name: Install dependencies
    #    run: |
    #      cat airflow_variables_dev.json | sed -e s/\\/home\\/airflow\\/gcs\\/dags\\/// > airflow_variables_ci.json
    #      python -m pip install --upgrade pip
    #      pip install -r requirements-ci.txt
    #  - name: Init Airflow SQLite database
    #    run: airflow db init
    #  - name: Import Airflow variables
    #    run: airflow variables import airflow_variables_ci.json
    #  - name: Pytest
    #    run: pytest dags/

  promote-to-prod:
    runs-on: ubuntu-latest
    # deploy only occurs when pr is merged
    if: github.event.pull_request.merged == true
    steps:
      - name: Create pull request
        run: |
          gh pr create \
          --base release \
          --head master \
          --title "[PRODUCTION] Update production Airflow environment" \
          --body "This PR was auto-generated by GitHub Actions.
          \n\nAfter merged and closed, this PR will trigger an action that updates DAGs, libs and schemas files from prod Airflow."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # --reviewer stellar/platform-committers

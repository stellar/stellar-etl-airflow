name: CI

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    branches:
      - master

jobs:
  tests:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == false
    steps:
      - uses: actions/checkout@v3

    #  - name: Setup Python
    #    uses: actions/setup-python@v4
    #    with:
    #      python-version: 3.8
    #  - name: Install dependencies
    #    run: |
    #      cat airflow_variables_dev.json | sed -e s/\\/home\\/airflow\\/gcs\\/dags\\/// > airflow_variables_ci.json
    #      python -m pip install --upgrade pip
    #      pip install -r requirements-ci.txt
    #  - name: Init Airflow SQLite database
    #    run: airflow db init
    #  - name: Import Airflow variables
    #    run: airflow variables import airflow_variables_ci.json
    #  - name: Pytest
    #    run: pytest dags/

  promote-to-prod:
    runs-on: ubuntu-latest
    needs: [tests]
    # deploy only occurs when pr is merged
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v3

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: release
          delete-branch: true
          title: '[PRODUCTION] Update production Airflow environment'
          body: |
            This PR was auto-generated by [create-pull-request][1]
            
            After merged and closed, this PR will trigger an action that updates DAGs, libs and schemas files from prod Airflow.

            [1]: https://github.com/peter-evans/create-pull-request
          team-reviewers: platform-committers
